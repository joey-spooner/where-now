<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Where Now?</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 16px;
      line-height: 1.4;
      color: #111;
      background: #f4f4f5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      display: flex;
      justify-content: center;
      background: #e5e7eb;
    }

    .app-shell {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      border-left: 1px solid #d4d4d8;
      border-right: 1px solid #d4d4d8;
    }

    header {
      padding: 0.9rem 1.2rem 0.7rem;
      background: #111827;
      color: #f9fafb;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
    }

    header h1 {
      font-size: 1.15rem;
      margin: 0;
      font-weight: 600;
    }

    header span {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    main {
      padding: 0.9rem 1rem 1rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    .section-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
      margin-bottom: 0.3rem;
    }

    .card {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 0.85rem 0.9rem;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
    }

    .row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .pill {
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #d4d4d8;
      background: #f9fafb;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .pill--active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    .time-options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.2rem;
    }

    .time-option {
      flex: 1 1 calc(33% - 0.5rem);
      min-width: 90px;
      text-align: center;
      font-size: 0.78rem;
      padding: 0.4rem 0.35rem;
      border-radius: 0.6rem;
      border: 1px solid #d4d4d8;
      background: #f9fafb;
      cursor: pointer;
    }

    .time-option--active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    .location-row {
      display: flex;
      gap: 0.45rem;
      margin-top: 0.4rem;
    }

    .location-row button {
      border-radius: 0.6rem;
      border: 1px solid #d4d4d8;
      background: #f9fafb;
      padding: 0.4rem 0.6rem;
      font-size: 0.78rem;
      flex: 0 0 auto;
      cursor: pointer;
      white-space: nowrap;
    }

    .location-row select {
      flex: 1 1 auto;
      border-radius: 0.6rem;
      border: 1px solid #d4d4d8;
      padding: 0.3rem 0.45rem;
      font-size: 0.78rem;
      background: #f9fafb;
    }

    .primary-button {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 0.8rem;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: #111827;
      color: #f9fafb;
      margin-top: 0.3rem;
    }

    .primary-button:active {
      transform: translateY(1px);
    }

    .pill-small {
      font-size: 0.7rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .pill-small span {
      font-size: 0.8rem;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .result-title {
      font-weight: 600;
      font-size: 1rem;
    }

    .result-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin: 0.4rem 0;
    }

    .result-description {
      font-size: 0.82rem;
      color: #4b5563;
      margin-bottom: 0.5rem;
    }

    .result-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.4rem;
    }

    .btn-secondary,
    .btn-outline {
      flex: 1;
      font-size: 0.82rem;
      border-radius: 0.6rem;
      padding: 0.55rem 0.5rem;
      cursor: pointer;
      border: 1px solid #d4d4d8;
      background: #f9fafb;
      text-align: center;
    }

    .btn-secondary {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    footer {
      padding: 0.5rem 1rem 0.7rem;
      font-size: 0.72rem;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    @media (min-width: 600px) {
      main {
        padding: 1rem 1.25rem 1.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <h1>Where Now?</h1>
      <span>Lisbon ‚Ä¢ Coast ‚Ä¢ Set√∫bal</span>
    </header>

    <main>
      <!-- 1. Category + Time + Location controls -->
      <section class="card">
        <div class="section-label">What are you in the mood for?</div>
        <div class="pill-group" id="category-group">
          <button class="pill pill--active" data-category="food">Food &amp; Drink</button>
          <button class="pill" data-category="outdoor">Outdoor / Nature</button>
          <button class="pill" data-category="culture">Culture &amp; Sites</button>
          <button class="pill" data-category="wildcard">Wildcard</button>
        </div>

        <div class="section-label" style="margin-top: 0.75rem;">How much time do you have?</div>
        <div class="time-options" id="time-group">
          <button class="time-option time-option--active" data-minutes="30">30 min</button>
          <button class="time-option" data-minutes="60">1 hr</button>
          <button class="time-option" data-minutes="120">2 hrs</button>
          <button class="time-option" data-minutes="240">Half day</button>
          <button class="time-option" data-minutes="480">Full day</button>
        </div>

        <div class="section-label" style="margin-top: 0.75rem;">Where are you starting from?</div>
        <div class="location-row">
          <button id="use-location">Use my location</button>
          <select id="base-location">
            <option value="paco">Pa√ßo de Arcos</option>
            <option value="lisbon">Lisbon center</option>
            <option value="cascais">Cascais / Estoril</option>
            <option value="caparica">Costa da Caparica</option>
            <option value="sesimbra">Sesimbra</option>
            <option value="setubal">Set√∫bal</option>
          </select>
        </div>

        <button class="primary-button" id="surprise-btn">
          üé≤ Surprise me
        </button>
      </section>

      <!-- 2. Result card (placeholder content for now) -->
      <section class="card" id="result-card">
        <div class="section-label">Suggestion</div>
        <div class="result-header">
          <div>
            <div class="result-title" id="place-name">
              Try this: Castelo de S√£o Jorge
            </div>
            <div class="result-meta">
              <div class="pill-small" id="place-category">
                <span>Culture &amp; Sites</span>
              </div>
              <div class="pill-small" id="place-rating">
                ‚≠ê 4.7 TripAdvisor
              </div>
              <div class="pill-small" id="place-weather-tag">
                ‚òÄ Good for sunny days
              </div>
            </div>
          </div>
          <div class="pill-small" id="place-status">
            <span>Open now ‚Ä¢ closes 21:00</span>
          </div>
        </div>

        <div class="result-description" id="place-description">
          Hilltop castle with panoramic views over Lisbon. Mix of indoor and outdoor spaces,
          easy to pair with a walk through Alfama.
        </div>

        <div class="row" style="margin-bottom: 0.4rem;">
          <div style="font-size: 0.78rem; color: #4b5563;" id="place-distance">
            ~18 min from your location ‚Ä¢ allow 90+ min
          </div>
        </div>

        <div class="result-actions">
          <button class="btn-secondary" id="go-here-btn">
            ‚úÖ Go here
          </button>
          <button class="btn-outline" id="another-btn">
            ‚Üª Show another
          </button>
        </div>

        <div style="margin-top: 0.5rem; font-size: 0.78rem;">
          <a href="#" id="gmaps-link" target="_blank" rel="noopener noreferrer">
            Open in Google Maps
          </a>
        </div>
      </section>
    </main>

    <footer>
      <div id="weather-summary">
        Weather: checking‚Ä¶
      </div>
      <div id="meta-summary">
        v0.1 ‚Ä¢ Local only
      </div>
    </footer>
  </div>

<script>
  // ---- CONSTANTS ----
  const PLACES_STORAGE_KEY = 'whereNow_places_v1';
  const SEEN_STORAGE_KEY = 'whereNow_seen_v1';

  const BASE_LOCATIONS = {
    paco: { lat: 38.691, lon: -9.308 },         // Pa√ßo de Arcos
    lisbon: { lat: 38.7223, lon: -9.1393 },     // Lisbon center
    cascais: { lat: 38.6979, lon: -9.4218 },    // Cascais
    caparica: { lat: 38.642, lon: -9.232 },     // Costa da Caparica
    sesimbra: { lat: 38.444, lon: -9.101 },     // Sesimbra
    setubal: { lat: 38.524, lon: -8.888 }       // Set√∫bal
  };

  // ---- BASIC APP STATE ----
  const appState = {
    coords: {
      // Default near Pa√ßo de Arcos if geolocation fails
      lat: 38.691,
      lon: -9.308
    },
    weather: {
      tempC: null,
      code: null,
      label: 'checking‚Ä¶',
      preferOutdoor: true,
      preferIndoor: false
    },
    places: [],
    placesLoaded: false,
    selectedPlace: null
  };

  // ---- DOM ELEMENTS ----
  const weatherSummaryEl = document.getElementById('weather-summary');
  const metaSummaryEl = document.getElementById('meta-summary');

  const nameEl = document.getElementById('place-name');
  const catEl = document.getElementById('place-category');
  const ratingEl = document.getElementById('place-rating');
  const weatherTagEl = document.getElementById('place-weather-tag');
  const statusEl = document.getElementById('place-status');
  const descEl = document.getElementById('place-description');
  const distanceEl = document.getElementById('place-distance');
  const gmapsEl = document.getElementById('gmaps-link');

  // ---- SMALL HELPERS ----

  function todayKey() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  function minutesSinceMidnight(d) {
    return d.getHours() * 60 + d.getMinutes();
  }

  function parseTimeToMinutes(hhmm) {
    const [h, m] = hhmm.split(':').map(Number);
    return h * 60 + m;
  }

  function formatMinutesToHHMM(mins) {
    const h = Math.floor(mins / 60) % 24;
    const m = mins % 60;
    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
  }

  function haversineKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const toRad = (deg) => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function getSelectedCategory() {
    const active = document.querySelector('#category-group .pill--active');
    return active ? active.dataset.category : 'wildcard';
  }

  function getSelectedTimeMinutes() {
    const active = document.querySelector('#time-group .time-option--active');
    return active ? Number(active.dataset.minutes) : 60;
  }

  function getOriginCoords() {
    // Prefer geolocation if available; otherwise fall back to base dropdown.
    const baseKey = document.getElementById('base-location').value;
    const base = BASE_LOCATIONS[baseKey] || BASE_LOCATIONS.paco;

    if (appState.coords && typeof appState.coords.lat === 'number') {
      return appState.coords;
    }
    return base;
  }

  // ---- SEEN-TODAY HANDLING ----

  function loadSeenToday() {
    const raw = localStorage.getItem(SEEN_STORAGE_KEY);
    if (!raw) return { date: todayKey(), ids: [] };

    try {
      const parsed = JSON.parse(raw);
      if (!parsed.date || parsed.date !== todayKey()) {
        return { date: todayKey(), ids: [] };
      }
      if (!Array.isArray(parsed.ids)) return { date: todayKey(), ids: [] };
      return parsed;
    } catch {
      return { date: todayKey(), ids: [] };
    }
  }

  function saveSeenToday(seen) {
    localStorage.setItem(SEEN_STORAGE_KEY, JSON.stringify(seen));
  }

  function markPlaceSeen(placeId) {
    const seen = loadSeenToday();
    if (!seen.ids.includes(placeId)) {
      seen.ids.push(placeId);
      saveSeenToday(seen);
    }
  }

  // ---- CATEGORY + TIME UI HANDLERS ----

  document.getElementById('category-group').addEventListener('click', (e) => {
    if (!e.target.dataset.category) return;
    [...document.querySelectorAll('#category-group .pill')]
      .forEach(p => p.classList.remove('pill--active'));
    e.target.classList.add('pill--active');
  });

  document.getElementById('time-group').addEventListener('click', (e) => {
    if (!e.target.dataset.minutes) return;
    [...document.querySelectorAll('#time-group .time-option')]
      .forEach(p => p.classList.remove('time-option--active'));
    e.target.classList.add('time-option--active');
  });

  // ---- LOCATION HANDLING ----

  async function detectLocation() {
    return new Promise((resolve) => {
      if (!navigator.geolocation) {
        console.warn('Geolocation not supported, using default coords.');
        return resolve(false);
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          appState.coords.lat = pos.coords.latitude;
          appState.coords.lon = pos.coords.longitude;
          console.log('Using geolocation coords:', appState.coords);
          resolve(true);
        },
        (err) => {
          console.warn('Geolocation failed, using default coords.', err);
          resolve(false);
        },
        {
          enableHighAccuracy: true,
          timeout: 5000
        }
      );
    });
  }

  document.getElementById('use-location').addEventListener('click', async () => {
    const ok = await detectLocation();
    if (ok) {
      alert('Location updated. I‚Äôll use this point for travel and weather.');
      loadWeather();
    } else {
      alert('Could not get your location. Using default Pa√ßo de Arcos area.');
    }
  });

  // ---- WEATHER LOGIC ----

  function classifyWeatherCode(code) {
    const rainy = [51, 53, 55, 56, 57, 61, 63, 65, 66, 67, 80, 81, 82];
    const snowy = [71, 73, 75, 77, 85, 86];
    const foggy = [45, 48];
    const stormy = [95, 96, 99];

    if (rainy.includes(code)) return 'rain';
    if (snowy.includes(code)) return 'snow';
    if (stormy.includes(code)) return 'storm';
    if (foggy.includes(code)) return 'fog';
    return 'clear';
  }

  function buildWeatherPreference(code) {
    const type = classifyWeatherCode(code);
    const prefs = {
      preferOutdoor: true,
      preferIndoor: false,
      label: ''
    };

    if (type === 'rain' || type === 'storm') {
      prefs.preferOutdoor = false;
      prefs.preferIndoor = true;
      prefs.label = 'rainy ‚Äì indoor is better';
    } else if (type === 'snow' || type === 'fog') {
      prefs.preferOutdoor = false;
      prefs.preferIndoor = true;
      prefs.label = 'low visibility ‚Äì indoor/mixed';
    } else {
      prefs.preferOutdoor = true;
      prefs.preferIndoor = false;
      prefs.label = 'good for outdoor & sun';
    }

    return prefs;
  }

  async function loadWeather() {
    const { lat, lon } = appState.coords;

    const url = `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${lat}&longitude=${lon}` +
      `&current_weather=true&timezone=auto`;

    try {
      weatherSummaryEl.textContent = 'Weather: checking‚Ä¶';

      const res = await fetch(url);
      if (!res.ok) throw new Error('Weather HTTP error ' + res.status);

      const data = await res.json();
      const cw = data.current_weather;
      if (!cw) throw new Error('Missing current_weather');

      const prefs = buildWeatherPreference(cw.weathercode);

      appState.weather.tempC = cw.temperature;
      appState.weather.code = cw.weathercode;
      appState.weather.preferOutdoor = prefs.preferOutdoor;
      appState.weather.preferIndoor = prefs.preferIndoor;
      appState.weather.label = prefs.label;

      const emoji = prefs.preferIndoor && !prefs.preferOutdoor
        ? 'üåß'
        : '‚òÄ';

      weatherSummaryEl.textContent =
        `Weather: ${emoji} ${cw.temperature.toFixed(0)}¬∞C, ${prefs.label}`;
    } catch (err) {
      console.error('Error loading weather', err);
      appState.weather.label = 'unavailable';
      weatherSummaryEl.textContent = 'Weather: unavailable';
    }
  }

  function scorePlaceForWeather(place, weather) {
    let score = 0;

    if (!weather || weather.label === 'unavailable') {
      return 0;
    }

    if (weather.preferIndoor) {
      if (place.indoorOutdoor === 'indoor') score += 3;
      if (place.indoorOutdoor === 'mixed') score += 2;
      if (place.goodInRain) score += 2;
      if (place.indoorOutdoor === 'outdoor' && !place.goodInRain) score -= 3;
    }

    if (weather.preferOutdoor) {
      if (place.indoorOutdoor === 'outdoor') score += 3;
      if (place.indoorOutdoor === 'mixed') score += 2;
      if (place.goodForSun) score += 2;
    }

    return score;
  }

  // ---- PLACES LOADING (from data/places.json + localStorage cache) ----

  async function loadPlaces() {
    const cached = localStorage.getItem(PLACES_STORAGE_KEY);
    if (cached) {
      try {
        const parsed = JSON.parse(cached);
        if (Array.isArray(parsed) && parsed.length > 0) {
          appState.places = parsed;
          appState.placesLoaded = true;
          updateMetaSummary();
          console.log('Loaded places from localStorage:', parsed.length);
          return;
        }
      } catch (e) {
        console.warn('Failed to parse cached places, refetching...', e);
      }
    }

    try {
      const res = await fetch('./data/places.json');
      if (!res.ok) throw new Error('Failed to fetch places.json: ' + res.status);
      const list = await res.json();
      if (!Array.isArray(list)) throw new Error('places.json is not an array');

      appState.places = list;
      appState.placesLoaded = true;
      localStorage.setItem(PLACES_STORAGE_KEY, JSON.stringify(list));
      console.log('Loaded places from network:', list.length);

      updateMetaSummary();
    } catch (err) {
      console.error('Error loading places:', err);
      appState.places = [];
      appState.placesLoaded = false;
      updateMetaSummary(true);
    }
  }

  function updateMetaSummary(isError) {
    if (isError) {
      metaSummaryEl.textContent = 'v0.5 ‚Ä¢ no places loaded';
      return;
    }
    const count = appState.places.length;
    metaSummaryEl.textContent = `v0.5 ‚Ä¢ ${count} place${count === 1 ? '' : 's'}`;
  }

  // ---- NO-RESULT DISPLAY ----

  function showNoResult(message) {
    appState.selectedPlace = null;

    nameEl.textContent = 'No suggestion right now';
    catEl.textContent = '';
    ratingEl.textContent = '';
    weatherTagEl.textContent = '';
    statusEl.textContent = '';
    descEl.textContent =
      message || 'Try changing the category, increasing your time window, or picking a different base location.';
    distanceEl.textContent = '';
    gmapsEl.href = '#';
  }

  // ---- OPENING HOURS & FEASIBILITY ----

  function isPlaceOpenForWindow(place, now, travelMin, windowMin) {
    const dayMap = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    const weekdayKey = dayMap[now.getDay()];
    const hoursForDay = place.openingHours?.[weekdayKey] || [];

    if (!hoursForDay || hoursForDay.length === 0) {
      return { ok: false };
    }

    const nowMin = minutesSinceMidnight(now);
    const arrivalMin = nowMin + travelMin;

    // How long can we realistically stay given travel + user time?
    const maxStayFromWindow = windowMin - travelMin;
    if (maxStayFromWindow <= 0) return { ok: false };

    // At least 30 minutes there, but not more than suggested minVisitMinutes
    const desiredStayMin = Math.max(
      30,
      Math.min(place.minVisitMinutes || 60, maxStayFromWindow)
    );

    for (const [startStr, endStr] of hoursForDay) {
      const start = parseTimeToMinutes(startStr);
      const end = parseTimeToMinutes(endStr);

      const departMin = arrivalMin + desiredStayMin;

      if (arrivalMin >= start && departMin <= end) {
        return {
          ok: true,
          closesAtMin: end,
          arrivalMin,
          stayMin: desiredStayMin
        };
      }
    }

    return { ok: false };
  }

  function evaluatePlace(place, now, timeAvailableMin, originCoords) {
    const distanceKm = haversineKm(
      originCoords.lat, originCoords.lon,
      place.lat, place.lng
    );

    // Simple travel time model: 30 km/h effective
    const travelMinRaw = (distanceKm / 30) * 60;
    const travelMin = Math.max(5, travelMinRaw); // minimum 5 minutes

    // If travel alone eats almost all the time, bail out
    if (travelMin >= timeAvailableMin - 15) {
      return { feasible: false };
    }

    const openInfo = isPlaceOpenForWindow(place, now, travelMin, timeAvailableMin);
    if (!openInfo.ok) {
      return { feasible: false };
    }

    const weatherScore = scorePlaceForWeather(place, appState.weather);

    return {
      feasible: true,
      distanceKm,
      travelMin,
      weatherScore,
      closesAtMin: openInfo.closesAtMin,
      arrivalMin: openInfo.arrivalMin,
      stayMin: openInfo.stayMin
    };
  }

  // ---- SELECTION LOGIC ----

  function chooseRandomPlace(skipId = null) {
    if (!appState.placesLoaded || appState.places.length === 0) {
      showNoResult('Places data is not loaded. Check your connection or JSON file.');
      return null;
    }

    const category = getSelectedCategory(); // food | outdoor | culture | wildcard
    const timeAvailableMin = getSelectedTimeMinutes();
    const originCoords = getOriginCoords();
    const now = new Date();

    // 1. Category + rating filter
    let candidates = appState.places.filter(p => {
      if (p.tripAdvisorRating && p.tripAdvisorRating < 4.0) return false;
      if (category !== 'wildcard' && p.category !== category) return false;
      return true;
    });

    if (skipId) {
      candidates = candidates.filter(p => p.id !== skipId);
    }

    if (candidates.length === 0) {
      showNoResult('No matching places for this category. Try a different category or wildcard.');
      return null;
    }

    // 2. Feasibility filter (time + opening hours)
    let evaluated = candidates
      .map(p => {
        const evalInfo = evaluatePlace(p, now, timeAvailableMin, originCoords);
        return { place: p, eval: evalInfo };
      })
      .filter(x => x.eval.feasible);

    console.log('Candidates after feasibility:', evaluated.map(x => ({
      id: x.place.id,
      name: x.place.name,
      distanceKm: x.eval.distanceKm.toFixed(1),
      travelMin: x.eval.travelMin.toFixed(0),
      closesAt: formatMinutesToHHMM(x.eval.closesAtMin),
      stayMin: x.eval.stayMin.toFixed(0),
      weatherScore: x.eval.weatherScore
    })));

    if (evaluated.length === 0) {
      showNoResult('Nothing feasible right now for this time window. Increase the time or choose a closer base location.');
      return null;
    }

    // 3. Seen-today filter
    const seen = loadSeenToday();
    const unseen = evaluated.filter(x => !seen.ids.includes(x.place.id));

    if (unseen.length > 0) {
      evaluated = unseen;
    }

    // 4. Weather-weighted randomness
    evaluated.sort((a, b) => b.eval.weatherScore - a.eval.weatherScore);

    const topN = Math.min(5, evaluated.length);
    const pool = evaluated.slice(0, topN);

    const randIndex = Math.floor(Math.random() * pool.length);
    const choice = pool[randIndex];

    return choice;
  }

  function renderPlaceChoice(choice) {
    const { place, eval: info } = choice;
    appState.selectedPlace = place;

    markPlaceSeen(place.id);

    // Name & category
    nameEl.textContent = place.name;
    catEl.textContent = place.category === 'food'
      ? 'Food & Drink'
      : place.category === 'outdoor'
        ? 'Outdoor / Nature'
        : 'Culture & Sites';

    // Rating
    const ratingValue = typeof place.tripAdvisorRating === 'number'
      ? place.tripAdvisorRating.toFixed(1)
      : '4.0';
    ratingEl.textContent = `‚≠ê ${ratingValue} TripAdvisor`;

    // Weather tag
    let weatherTag = '';
    if (place.indoorOutdoor === 'indoor') {
      weatherTag = 'üè† Mostly indoor';
    } else if (place.indoorOutdoor === 'outdoor') {
      weatherTag = '‚òÄ Outdoor spot';
    } else {
      weatherTag = 'üå§ Indoor & outdoor mix';
    }

    if (appState.weather.preferIndoor && place.goodInRain) {
      weatherTag += ' ‚Ä¢ good in rain';
    } else if (appState.weather.preferOutdoor && place.goodForSun) {
      weatherTag += ' ‚Ä¢ great in sun';
    }

    weatherTagEl.textContent = weatherTag;

    // Status (open now, closes at)
    const closesHHMM = formatMinutesToHHMM(info.closesAtMin);
    statusEl.textContent = `Open now ‚Ä¢ closes ${closesHHMM}`;

    // Description / notes
    descEl.textContent = place.notes || '';

    // Distance & time
    const distText = info.distanceKm < 1
      ? '< 1 km away'
      : `${info.distanceKm.toFixed(1)} km away`;
    const travelText = Math.round(info.travelMin);
    const stayText = Math.round(info.stayMin);

    distanceEl.textContent =
      `~${travelText} min from you (${distText}) ‚Ä¢ allow ${stayText}+ min there`;

    // Google Maps link
    gmapsEl.href = place.gmapsUrl || '#';
  }

  // ---- BUTTON HANDLERS ----

  document.getElementById('surprise-btn').addEventListener('click', () => {
    const choice = chooseRandomPlace();
    if (!choice) return;
    renderPlaceChoice(choice);
  });

  document.getElementById('another-btn').addEventListener('click', () => {
    if (!appState.selectedPlace) {
      const first = chooseRandomPlace();
      if (!first) return;
      renderPlaceChoice(first);
      return;
    }
    const choice = chooseRandomPlace(appState.selectedPlace.id);
    if (!choice) return;
    renderPlaceChoice(choice);
  });

  document.getElementById('go-here-btn').addEventListener('click', () => {
    if (!appState.selectedPlace) {
      alert('Pick a place first.');
      return;
    }
    markPlaceSeen(appState.selectedPlace.id);
    alert(`Nice. Marked "${appState.selectedPlace.name}" as done for today.`);
  });

  const resetBtn = document.getElementById('reset-today-btn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      localStorage.removeItem(SEEN_STORAGE_KEY);
      showNoResult('Cleared today‚Äôs history. Hit ‚ÄúSurprise me‚Äù to start again.');
    });
  }

  // ---- INITIALIZE ON LOAD ----
  (async function init() {
    await detectLocation();   // if it fails, we fall back to base locations
    await loadWeather();
    await loadPlaces();
  })();
</script>
</body>
</html>